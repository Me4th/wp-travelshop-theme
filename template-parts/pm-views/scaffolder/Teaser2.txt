<?php

// This Teaser is used for the wish-/favlist feature

/**
 * @var array $data
 */

/**
 * @var Pressmind\ORM\Object\MediaObject $mo
 */
$mo = $data['media_object'];

/**
 * @var Custom\MediaType\###CLASSNAME### $moc
 */
$moc = $mo->getDataForLanguage(TS_LANGUAGE_CODE);

use Pressmind\Search\CheapestPrice;
use Pressmind\Travelshop\PriceHandler;

$CheapestPriceFilter = new CheapestPrice();

if (empty($_GET['pm-dr']) === false) {
    $dateRange = BuildSearch::extractDaterange($_GET['pm-dr']);
    if ($dateRange !== false) {
        $CheapestPriceFilter->date_from = $dateRange[0];
        $CheapestPriceFilter->date_to = $dateRange[1];
    }
}

if (empty($_GET['pm-du']) === false) {
    $durationRange = BuildSearch::extractDurationRange($_GET['pm-du']);
    if ($durationRange !== false) {
        $CheapestPriceFilter->duration_from = $durationRange[0];
        $CheapestPriceFilter->duration_to = $durationRange[1];
    }
}


if (empty($_GET['pm-pr']) === false) {
    $priceRange = BuildSearch::extractPriceRange($_GET['pm-pr']);
    if ($priceRange !== false) {
        $CheapestPriceFilter->price_from = $priceRange[0];
        $CheapestPriceFilter->price_to = $priceRange[1];
    }
}

$CheapestPriceFilter->occupancies = [2];

$cheapest_price = $mo->getCheapestPrice($CheapestPriceFilter);


/**
 * DON'T USE WordPress Stuff here
 */

// Build the detail-page link,
// we add some search values to deliver to customize the offers on the the detail page
$url = SITE_URL . $mo->getPrettyUrl(TS_LANGUAGE_CODE);

// only this search params are transmitted, price range (pm-pr), date range (pm-dr)
$allowedParams = ['pm-pr', 'pm-dr'];
$filteredParams = array_filter($_GET,
    function ($key) use ($allowedParams) {
        return in_array($key, $allowedParams);
    },
    ARRAY_FILTER_USE_KEY
);

if (empty($filteredParams) === false) {
    $query_string = http_build_query($filteredParams);
    $url .= '?' . $query_string;
}
?>
<section class="wishlist-item">
    <div class="wishlist-item-image">
        <a href="<?php echo $url; ?>">
            <?php if (is_array($moc->bilder_default)) { ?>
                <img
                        src="<?php echo $moc->bilder_default[0]->getUri('teaser'); ?>"
                        alt="<?php echo strip_tags($mo->name); ?>"
                        title="<?php echo $moc->bilder_default[0]->copyright; ?>"
                />
            <?php } elseif (is_string($moc->bilder_default)) {
                // @TODO the placeholder image below is only for a better theme developer onboarding, remove in production.
                // if the property "$moc->bilder_default" is not set in this object type, check if there is another named image property
                ?>
                <img src="/placeholder.svg?wh=250x170&text=<?php echo urlencode($moc->bilder_default); ?>"
                     class="card-img-top"/>
            <?php } ?>
        </a>
    </div>
    <div class="wishlist-item-data">
        <span class="name">
            <a href="<?php echo $url; ?>"><?php echo $mo->name; ?></a>
        </span>
        <span class="price">
            <div data-pm-id="<?php echo $mo->id; ?>" class="remove-from-wishlist">entfernen</div>

            <a href="<?php echo $url; ?>"><?php echo ' ab <strong>'.PriceHandler::format($cheapest_price->price_total).'</strong>' ?></a>




        </span>
    </div>
</section>