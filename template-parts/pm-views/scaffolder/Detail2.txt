<?php

global $PMTravelShop;

use Pressmind\HelperFunctions;
use Pressmind\Search\CheapestPrice;
use Pressmind\Travelshop\PriceHandler;
use Pressmind\Travelshop\RouteHelper;

/**
 * @var array $data
 */

/**
 * @var Pressmind\ORM\Object\MediaObject $mo
 */
$mo = $data['media_object'];

/**
 * @var Custom\MediaType\Reise $moc
 */
$moc = $mo->getDataForLanguage(TS_LANGUAGE_CODE);


foreach ($moc->unterkunftsverknuepfung_default as $key => $unterkunft_link) {

    $mo_related[$key] = new \Pressmind\ORM\Object\MediaObject($unterkunft_link->id_media_object_link, true);

    // if the linked object is not available (in most cases it must be public)
    if (empty($mo_related[$key]->id)) {
        continue;
    }

    /**
     * this is for better code complementation in lovely phpstorm
     * @var $unterkunft_moc \Custom\MediaType\Unterkunft
     */
    $moc_related[$key] = $mo_related[$key]->getDataForLanguage();

}


/**
 * Set the Cheapest Price, based on the current search parameters
 */

$CheapestPriceFilter = new CheapestPrice();
if (empty($_GET['pm-dr']) === false) {
    $dateRange = BuildSearch::extractDaterange($_GET['pm-dr']);
    if ($dateRange !== false) {
        $CheapestPriceFilter->date_from = $dateRange[0];
        $CheapestPriceFilter->date_to = $dateRange[1];
    }
}

if (empty($_GET['pm-du']) === false) {
    $durationRange = BuildSearch::extractDurationRange($_GET['pm-du']);
    if ($durationRange !== false) {
        $CheapestPriceFilter->duration_from = $durationRange[0];
        $CheapestPriceFilter->duration_to = $durationRange[1];
    }
}


if (empty($_GET['pm-pr']) === false) {
    $priceRange = BuildSearch::extractPriceRange($_GET['pm-pr']);
    if ($priceRange !== false) {
        $CheapestPriceFilter->price_from = $priceRange[0];
        $CheapestPriceFilter->price_to = $priceRange[1];
    }
}

//@todo add idd and idbp to the cheapest price

$CheapestPriceFilter->occupancies = [2];

$cheapest_price = $mo->getCheapestPrice($CheapestPriceFilter);

$pictures = $moc->bilder_default;

?>
<div class="content-main">

    <article class="travelshop-detail-container">
        
        <section class="container">

            <div class="row">

            <?php
                $breadcrumb = array();
                $tmp = new stdClass();
                $tmp->name = 'Startseite';
                $tmp->url = site_url();
                $breadcrumb[] = $tmp;

                $breadcrumb_search_url = site_url() . '/' . RouteHelper::get_url_by_object_type($mo->id_object_type) . '/';
                $breadcrumb_search_url = '';
                if (is_array($moc->reiseart_default)) {
                    foreach ($moc->reiseart_default as $item) {
                        $reiseart = $item->toStdClass();
                        $tmp = new stdClass();
                        $tmp->name = $reiseart->item->name;
                        $tmp->url = $breadcrumb_search_url . '?pm-c[reiseart_default]=' . $reiseart->item->id;
                        $breadcrumb[] = $tmp;
                    }
                }
                if (is_array($moc->zielgebiet_default)) {
                    foreach ($moc->zielgebiet_default as $item) {
                        $zielgebiet = $item->toStdClass();
                        $tmp = new stdClass();
                        $tmp->name = $zielgebiet->item->name;
                        $tmp->url = $breadcrumb_search_url . '?pm-c[zielgebiet_default]=' . $zielgebiet->item->id;;
                        $breadcrumb[] = $tmp;
                    }
                }

                $tmp = new stdClass();
                $tmp->name = strip_tags($moc->headline_default);
                $tmp->url = null;
                $breadcrumb[] = $tmp;

                // HARD BREADCRUMB BECAUSE OF BUG
                echo '<section class="breadcrumb-wrapper"><div class="container"><nav aria-label="breadcrumb"><ol itemscope="" itemtype="https://schema.org/BreadcrumbList" class="breadcrumb"><li itemprop="itemListElement" itemscope="" itemtype="https://schema.org/ListItem" class="breadcrumb-item breadcrumb-home"><a itemprop="item" href="https://travelshop.michaelamting.de"> <span class="breadcrumb-name" itemprop="name">Travelshop <span class="breadcrumb-sep"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-right" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="#777" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><polyline points="9 6 15 12 9 18"></polyline></svg></span></span></a> <meta itemprop="position" content="2"></li><li class="bc-separator" style="display: none;"> <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="#777" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><polyline points="15 6 9 12 15 18"></polyline></svg><a itemprop="item" href="https://travelshop.michaelamting.de/reise-suche/?pm-c[reiseart_default]=kF332DCB8-FEF6-71C4-F9B9-0435E23EEAE5">Radreisen anzeigen</a></li> <li itemprop="itemListElement" itemscope="" itemtype="https://schema.org/ListItem" class="breadcrumb-item "><a itemprop="item" href="https://travelshop.michaelamting.de/reise-suche/?pm-c[reiseart_default]=kF332DCB8-FEF6-71C4-F9B9-0435E23EEAE5"> <span class="breadcrumb-name" itemprop="name">Radreisen <span class="breadcrumb-sep"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-right" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="#777" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><polyline points="9 6 15 12 9 18"></polyline></svg></span></span></a> <meta itemprop="position" content="3"></li><li itemprop="itemListElement" itemscope="" itemtype="https://schema.org/ListItem" class="breadcrumb-item "><a itemprop="item" href="https://travelshop.michaelamting.de/reise-suche/?pm-c[zielgebiet_default]=F846ED62-9CC5-E3C4-E3E1-14B8DD7EC50E"> <span class="breadcrumb-name" itemprop="name">Schweiz <span class="breadcrumb-sep"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-right" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="#777" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><polyline points="9 6 15 12 9 18"></polyline></svg></span></span></a> <meta itemprop="position" content="4"></li><li itemprop="itemListElement" itemscope="" itemtype="https://schema.org/ListItem" class="breadcrumb-item "><a itemprop="item" href="https://travelshop.michaelamting.de/reise-suche/?pm-c[zielgebiet_default]=kD83342A3-9861-8672-9330-4251E13556F1"> <span class="breadcrumb-name" itemprop="name">St. Moritz <span class="breadcrumb-sep"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-right" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="#777" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><polyline points="9 6 15 12 9 18"></polyline></svg></span></span></a> <meta itemprop="position" content="5"></li><li itemprop="itemListElement" itemscope="" itemtype="https://schema.org/ListItem" class="breadcrumb-item "><span class="breadcrumb-name" itemprop="name">Große Schweiz-Rundreise <span class="breadcrumb-sep"></span></span><meta itemprop="position" content="6"></li></ol></nav></div></section>';
                // the_breadcrumb(null, null, $breadcrumb);
                ?>

                <div class="col-12 col-lg-8">

                    <div class="travelshop-detail-head">

                        <div class="travelshop-detail-badge">NEU</div>

                        <div class="travelshop-image-slider-wrapper">
                        
                            <div class="travelshop-image-slider">
                                
                                <?php foreach($pictures as $picture) { ?>
                                    <div>
                                        <img src="<?php echo $picture->getUri('detail'); ?>" alt="<?php echo $picture->alt; ?>" loading="lazy" />
                                        <div class="travelshop-image-slider-copyright">
                                            <?php echo $picture->copyright; ?>
                                        </div>
                                    </div>
                                <?php } ?>
                                
                            </div>

                            <!-- OVERLAYGALLERY: START -->
                            <div id="detail-gallery-overlay">
                                <button class="detail-gallery-overlay-close">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-x" width="28" height="28"
                                        viewBox="0 0 24 24" stroke-width="1.5" stroke="#FFFFFF" fill="none" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z"/>
                                        <line x1="18" y1="6" x2="6" y2="18"/>
                                        <line x1="6" y1="6" x2="18" y2="18"/>
                                    </svg>
                                </button>
                                <!-- GALLERY_SLIDER: START -->
                                <div class="detail-gallery-overlay-slider">
                                    <div class="detail-gallery-overlay-inner" id="detail-gallery-overlay-inner">

                                        <?php
                                        foreach ($pictures as $picture) {
                                            ?>
                                            <div class="detail-gallery-overlay-item">
                                                <div class="detail-gallery-overlay-item--image">
                                                    <img src="<?php echo $picture->getUri('detail'); ?>" class="w-100 h-100"/>
                                                </div>
                                                <div class="detail-gallery-overlay-item--caption">
                                                    <?php echo $picture->caption; ?>
                                                    <small><?php echo $picture->copyright; ?></small>
                                                </div>
                                            </div>
                                        <?php } ?>

                                    </div>
                                </div>
                                <!-- GALLERY_SLIDER: END -->

                                <!-- GALLERY_THUMBNAILS: START -->
                                <div class="detail-gallery-thumbnails" id="detail-gallery-thumbnails">

                                    <?php
                                    foreach ($pictures as $picture) {
                                        ?>
                                        <div class="detail-gallery-thumbnail-item">
                                            <div class="detail-gallery-thumbnail-item--image">
                                                <img src="<?php echo $picture->getUri('detail'); ?>" class="w-100 h-100"/>
                                            </div>
                                        </div>
                                    <?php } ?>

                                </div>
                                <!-- GALLERY_THUMBNAILS: END -->
                            </div>
                            <!-- OVERLAYGALLERY: END -->
                        
                        </div>

                        
                        <div class="travelshop-detail-wrapper">

                            <div class="travelshop-detail-details">
                                <?php if(!empty($moc->zielgebiet_default[0]) && !empty($moc->reiseart_default[0])) { ?>
                                    <div class="travelshop-detail-additional">
                                        <small>
                                            <span class="country">
                                                <?php echo $moc->zielgebiet_default[0]->__get('item')->name; ?>
                                            </span>
                                            ·
                                            <span class="type">
                                                <?php echo $moc->reiseart_default[0]->__get('item')->name; ?>
                                            </span>
                                        </small>
                                        <?php if(!empty($mo->code)) { ?>
                                            <small class="code">
                                                Code: <?php echo $mo->code; ?>
                                            </small>
                                        <?php } ?>
                                    </div>
                                <?php } ?>
                                <?php 
                                    // HARD BREADCRUMB BECAUSE OF BUG
                                    echo '<section class="breadcrumb-wrapper"><div class="container"><nav aria-label="breadcrumb"><ol itemscope="" itemtype="https://schema.org/BreadcrumbList" class="breadcrumb"><li itemprop="itemListElement" itemscope="" itemtype="https://schema.org/ListItem" class="breadcrumb-item breadcrumb-home"><a itemprop="item" href="https://travelshop.michaelamting.de"> <span class="breadcrumb-name" itemprop="name">Travelshop <span class="breadcrumb-sep"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-right" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="#777" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><polyline points="9 6 15 12 9 18"></polyline></svg></span></span></a> <meta itemprop="position" content="2"></li><li class="bc-separator" style="display: none;"> <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="#777" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><polyline points="15 6 9 12 15 18"></polyline></svg><a itemprop="item" href="https://travelshop.michaelamting.de/reise-suche/?pm-c[reiseart_default]=kF332DCB8-FEF6-71C4-F9B9-0435E23EEAE5">Radreisen anzeigen</a></li> <li itemprop="itemListElement" itemscope="" itemtype="https://schema.org/ListItem" class="breadcrumb-item "><a itemprop="item" href="https://travelshop.michaelamting.de/reise-suche/?pm-c[reiseart_default]=kF332DCB8-FEF6-71C4-F9B9-0435E23EEAE5"> <span class="breadcrumb-name" itemprop="name">Radreisen <span class="breadcrumb-sep"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-right" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="#777" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><polyline points="9 6 15 12 9 18"></polyline></svg></span></span></a> <meta itemprop="position" content="3"></li><li itemprop="itemListElement" itemscope="" itemtype="https://schema.org/ListItem" class="breadcrumb-item "><a itemprop="item" href="https://travelshop.michaelamting.de/reise-suche/?pm-c[zielgebiet_default]=F846ED62-9CC5-E3C4-E3E1-14B8DD7EC50E"> <span class="breadcrumb-name" itemprop="name">Schweiz <span class="breadcrumb-sep"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-right" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="#777" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><polyline points="9 6 15 12 9 18"></polyline></svg></span></span></a> <meta itemprop="position" content="4"></li><li itemprop="itemListElement" itemscope="" itemtype="https://schema.org/ListItem" class="breadcrumb-item "><a itemprop="item" href="https://travelshop.michaelamting.de/reise-suche/?pm-c[zielgebiet_default]=kD83342A3-9861-8672-9330-4251E13556F1"> <span class="breadcrumb-name" itemprop="name">St. Moritz <span class="breadcrumb-sep"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-right" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="#777" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><polyline points="9 6 15 12 9 18"></polyline></svg></span></span></a> <meta itemprop="position" content="5"></li><li itemprop="itemListElement" itemscope="" itemtype="https://schema.org/ListItem" class="breadcrumb-item "><span class="breadcrumb-name" itemprop="name">Große Schweiz-Rundreise <span class="breadcrumb-sep"></span></span><meta itemprop="position" content="6"></li></ol></nav></div></section>';
                                    // the_breadcrumb(null, null, $breadcrumb);
                                ?>
                                <div class="travelshop-detail-heading">
                                    <h1><?php echo strip_tags($mo->name); ?></h1>
                                    <div    data-pm-id="<?php echo $mo->id; ?>"
                                            data-pm-ot="<?php echo $mo->id_object_type; ?>"
                                            data-pm-dr="<?php echo !is_null($cheapest_price) ? $cheapest_price->date_arrival->format('Ymd').'-'.$cheapest_price->date_arrival->format('Ymd') : ''; ?>"
                                            data-pm-du="<?php echo !is_null($cheapest_price) ? $cheapest_price->duration : ''; ?>"
                                            class="add-to-wishlist">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-heart" width="30" height="30" viewBox="0 0 24 24" stroke-width="1.5" stroke="#06f" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <path class="wishlist-heart" d="M19.5 13.572l-7.5 7.428l-7.5 -7.428m0 0a5 5 0 1 1 7.5 -6.566a5 5 0 1 1 7.5 6.572" />
                                        </svg>
                                    </div>
                                </div>
                                <p class="subline"><?php echo strip_tags($moc->subline_default); ?></p>

                                <?php if (empty($moc->usp_default) === false) { ?>
                                    <div class="travelshop-detail-services-mobile">
                                        <?php echo $moc->usp_default; ?>
                                    </div>
                                <?php } ?>
                                
                            </div>

                            <?php if(count($pictures) > 1) { ?>
                                <div style="background-image: url(<?php echo $pictures[1]->getUri('detail_thumb'); ?>);" class="travelshop-detail-gallerythumb">
                                    <span class="travelshop-detail-gallerythumb-count">
                                        <?php if(count($pictures) >= 3) { ?>
                                            + <?php echo count($pictures) - 2; ?>
                                        <?php } ?>
                                    </span>
                                </div>
                            <?php } ?>

                        </div>

                    </div>

                </div>

                <div class="col-12 col-lg-4 travelshop-detail-info">
                    <div class="travelshop-detail-info-head">
                        <h2><?php echo strip_tags($mo->name); ?></h2>
                        <p><?php echo strip_tags($moc->subline_default); ?></p>
                        <?php if (empty($moc->usp_default) === false) { ?>
                            <div class="travelshop-detail-services-desktop">
                                <?php echo $moc->usp_default; ?>
                            </div>
                        <?php } ?>
                    </div>
                    <?php
                        // pricebox
                        load_template(get_template_directory() . '/template-parts/pm-views/detail-blocks/travelshop-price-box.php', false, array_merge($data, array('cheapest_price' => $cheapest_price)));
                    ?>
                </div>

            </div>
            
            <?php 
                // Booking Date Modal
                $args = [];
                $args['id_post'] = 50;
                $args['title'] = 'Reisetermin wählen';
                ob_start();
                load_template(get_template_directory() . '/template-parts/pm-views/detail-blocks/booking-offers.php', false, array_merge($data, array('cheapest_price' => $cheapest_price)));
                $args['content'] = ob_get_contents();
                ob_end_clean();
                include(get_template_directory() . '/template-parts/layout-blocks/modalscreen.php' ); 
            ?>
            
        </section>

        <section class="container"> 
            <div class="row">
                <div class="col-12">
                    <?php include(get_template_directory() . '/template-parts/pm-views/detail-blocks/booking-offers-calendar.php'); ?>
                </div>
            </div>
        </section>

        <section class="container travelshop-content-wrapper"> 
            <div class="row flex-column-reverse flex-lg-row">
                <div class="col-12 col-lg-8">
                    <h2><span><?php echo strip_tags($mo->name); ?></span></h2>
                    <hr />
                    <p class="mb-0"><strong><?php echo strip_tags($moc->subline_default); ?></strong></p>
                    <?php if (empty($moc->usp_default) === false) { ?>
                        <div class="travelshop-detail-usps">
                            <?php echo $moc->usp_default; ?>
                        </div>
                    <?php } ?>
                    <p>Einleitung: Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua.</p>
                    <div class="travelshop-itinerary-toggleall">
                        <h2>Reiseverlauf</h2>
                        <span class="btn btn-primary it-open">Alle öffnen</span>
                        <span class="btn btn-primary it-close">Alle schließen</span>
                    </div>
                    <hr class="mb-4" />
                    <?php // load itinerary
                    load_template(get_template_directory() . '/template-parts/pm-views/detail-blocks/travelshop-itinerary.php', false, array('moc' => $moc, 'mo' => $mo, 'cheapest_price' => $cheapest_price)); ?>
                    <?php if(isset($mo_related)) { ?>

                        <section class="travelshop-lodgings-wrapper">
                            <h2>Unterkünfte</h2>
                            <hr />
                            
                            <?php foreach($mo_related as $key => $lodging) { ?>

                                <div class="travelshop-lodgings-element <?php echo $key == 0 ? 'lodging-open' : ''; ?>">
                                    <h3>
                                        <div class="travelshop-lodgings-element-title">
                                            <span><?php echo $lodging->name ?></span>
                                            <div class="lodging-star-rating">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-star" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="#ffbf00" fill="#ffbf00" stroke-linecap="round" stroke-linejoin="round">
                                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                    <path d="M12 17.75l-6.172 3.245l1.179 -6.873l-5 -4.867l6.9 -1l3.086 -6.253l3.086 6.253l6.9 1l-5 4.867l1.179 6.873z" />
                                                </svg>
                                                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-star" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="#ffbf00" fill="#ffbf00" stroke-linecap="round" stroke-linejoin="round">
                                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                    <path d="M12 17.75l-6.172 3.245l1.179 -6.873l-5 -4.867l6.9 -1l3.086 -6.253l3.086 6.253l6.9 1l-5 4.867l1.179 6.873z" />
                                                </svg>
                                                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-star" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="#ffbf00" fill="#ffbf00" stroke-linecap="round" stroke-linejoin="round">
                                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                    <path d="M12 17.75l-6.172 3.245l1.179 -6.873l-5 -4.867l6.9 -1l3.086 -6.253l3.086 6.253l6.9 1l-5 4.867l1.179 6.873z" />
                                                </svg>
                                                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-star" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="#ffbf00" fill="#ffbf00" stroke-linecap="round" stroke-linejoin="round">
                                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                    <path d="M12 17.75l-6.172 3.245l1.179 -6.873l-5 -4.867l6.9 -1l3.086 -6.253l3.086 6.253l6.9 1l-5 4.867l1.179 6.873z" />
                                                </svg>
                                                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-star" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="#ffbf00" fill="#ffbf00" stroke-linecap="round" stroke-linejoin="round">
                                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                    <path d="M12 17.75l-6.172 3.245l1.179 -6.873l-5 -4.867l6.9 -1l3.086 -6.253l3.086 6.253l6.9 1l-5 4.867l1.179 6.873z" />
                                                </svg>
                                            </div>
                                        </div>
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-plus travelshop-itinerary-step-open" width="30" height="30" viewBox="0 0 24 24" stroke-width="2.5" stroke="#06f" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <line x1="12" y1="5" x2="12" y2="19" />
                                            <line x1="5" y1="12" x2="19" y2="12" />
                                        </svg>
                                    </h3>
                                    <div class="travelshop-lodgings-element-more">
                                        <?php echo $moc_related[$key]->beschreibung_text_default; ?>
                                        <div class="travelshop-lodgings-element-gallery lod-gallery-<?php echo $key; ?>">
                                            <?php foreach($moc_related[$key]->bilder_default as $picture) { ?>
                                                <a href="<?php echo $picture->getUri('detail'); ?>" data-lightbox="lodging-gallery-<?php echo $key; ?>">
                                                    <img src="<?php echo $picture->getUri('teaser'); ?>" alt="<?php echo $picture->alt; ?>" />
                                                    <div class="travelshop-lodgings-element-gallery-copyright">
                                                        <?php echo $picture->copyright; ?>
                                                    </div>
                                                </a>
                                            <?php } ?>
                                        </div>
                                        <?php // var_dump($moc_related[$key]->bilder_default); ?>
                                    </div>
                                </div>

                                <hr />

                            <?php } ?>
                    
                        </section>
                    <?php } ?>
                </div>
                <div class="col-12 col-lg-4">
                    <div class="travelshop-detail-sidebar">
                        <?php // load google maps image
                            load_template(get_template_directory() . '/template-parts/pm-views/detail-blocks/travelshop-gmaps-box.php', false, array('moc' => $moc, 'mo' => $mo, 'cheapest_price' => $cheapest_price));
                            if(!empty($moc->leistungen_default) && isset($moc->leistungen_default)) { ?>
                                <div class="travelshop-detail-services">
                                    <h2>Leistungen</h2>
                                    <?php echo $moc->leistungen_default; ?>
                                </div>
                            <?php } ?>
                    </div>
                </div>
            </div>
        </section>

        <div class="travelshop-detail-mobile-bar">
            <?php 
                $c_dates = 0;
                foreach($mo->booking_packages as $booking_package){
                    $c_dates += count($booking_package->dates);
                }
                $date = $booking_package->dates[0];
                $housing_option = $date->getHousingOptions();
                $housing_package = $housing_option[0]->getHousingPackage();
                $cheapest_price_filter = new CheapestPrice();
                $cheapest_price_filter->id_option = $housing_option[0]->id;
                $cheapest_price_filter->id_booking_package = $housing_option[0]->id_booking_package;
                $cheapest_price_filter->id_date = $date->id;
                $housing_options_cheapest_price = $mo->getCheapestPrice($cheapest_price_filter);
            ?>
            <div class="container">
                <span class="travelshop-detail-mobile-bar-title"><?php echo strip_tags($mo->name); ?></span>
                <p>
                    <?php echo $booking_package->duration; ?> Tag<?php echo($booking_package->duration > 1 ? 'e' : ''); ?>
                    - ab <strong><?php echo str_replace('&nbsp;', '', PriceHandler::format($mo->getCheapestPrice($cheapest_price_filter)->price_total)); ?></strong>
                    <?php if (($discount = PriceHandler::getDiscount($housing_options_cheapest_price)) !== false) { ?>
                    <span class="discount-label">
                        <span class="price"><?php echo str_replace('&nbsp;', '', $discount['price_before_discount']); ?></span>
                        <span class="discount"><?php echo $discount['price_delta']; ?></span>
                    </span>
                    <?php } ?>
                </p>
                <div class="travelshop-detail-mobile-bar-cta">
                    <div class="travelshop-detail-mobile-bar-date">
                        <span class="date">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-event" width="20" height="20" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                <rect x="4" y="5" width="16" height="16" rx="2" />
                                <line x1="16" y1="3" x2="16" y2="7" />
                                <line x1="8" y1="3" x2="8" y2="7" />
                                <line x1="4" y1="11" x2="20" y2="11" />
                                <rect x="8" y="15" width="2" height="2" />
                            </svg>
                            <a class="show-dates" data-modal="true" data-modal-id="50">
                                <?php echo HelperFunctions::dayNumberToLocalDayName($date->departure->format('N'), 'short'); ?>.
                                <?php echo $date->departure->format('d.m.'); ?>
                                -
                                <?php echo HelperFunctions::dayNumberToLocalDayName($date->arrival->format('N'), 'short'); ?>.
                                <?php echo $date->arrival->format('d.m.Y'); ?>
                            </a>
                        </span>
                    </div>
                    <a class="btn btn-primary btn-block booking-btn green" data-modal="true" data-modal-id="50" target="_blank" rel="nofollow">
                        zur Buchung
                    </a>
                </div>
            </div>
        </div>
        <div class="container">
        
        <?php
            $args = [
                'headline' => 'Weitere Reisen entdecken',
                'text' => 'Travel is the movement of people between relatively distant geographical locations, and can involve travel by foot, bicycle, automobile, train, boat, bus, airplane, or other means, with or without luggage, and can be one way or round trip.',
                'search' => [
                        'pm-li' => '0,4',
                        'pm-o' => 'rand',
                        'pm-ot' => TS_TOUR_PRODUCTS
                ]
            ];
            load_template_transient(get_template_directory().'/template-parts/layout-blocks/product-teaser.php', false, $args);
            ?>
        </div>

    </article>

</div>