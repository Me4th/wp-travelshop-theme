<?php
/**
 * @var array $data
 */

/**
 * @var Pressmind\ORM\Object\MediaObject $mo
 */

use Pressmind\Search\CheapestPrice;

$mo = $data['media_object'];

/**
 * @var Custom\MediaType\Reise $moc
 */
$moc = $mo->getDataForLanguage(TS_LANGUAGE_CODE);

/**
 * Set the Cheapest Price, based on the current search parameters
 */

$CheapestPriceFilter = new CheapestPrice();

if (empty($_GET['pm-dr']) === false) {
    $dateRange = BuildSearch::extractDaterange($_GET['pm-dr']);
    if ($dateRange !== false) {
        $CheapestPriceFilter->date_from = $dateRange[0];
        $CheapestPriceFilter->date_to = $dateRange[1];
    }
}

if (empty($_GET['pm-du']) === false) {
    $durationRange = BuildSearch::extractDurationRange($_GET['pm-du']);
    if ($durationRange !== false) {
        $CheapestPriceFilter->duration_from = $durationRange[0];
        $CheapestPriceFilter->duration_to = $durationRange[1];
    }
}


if (empty($_GET['pm-pr']) === false) {
    $priceRange = BuildSearch::extractPriceRange($_GET['pm-pr']);
    if ($priceRange !== false) {
        $CheapestPriceFilter->price_from = $priceRange[0];
        $CheapestPriceFilter->price_to = $priceRange[1];
    }
}

$CheapestPriceFilter->occupancies = [2];

$cheapest_price = $mo->getCheapestPrice($CheapestPriceFilter);


$class = empty($data['custom_data']->class) ? 'col-12' : $data['custom_data']->class;

/**
 * DON'T USE WordPress Stuff here
 */
?>

<?php
// Build the detail-page link,
// we add some search values to deliver to customize the offers on the the detail page
$url = SITE_URL . $mo->getPrettyUrl(TS_LANGUAGE_CODE);

// only this search params are transmitted, price range (pm-pr), date range (pm-dr), duration range (pm-du), housingoption occupancy (pm-ho)
$allowedParams = ['pm-pr', 'pm-dr', 'pm-du', 'pm-ho'];
$filteredParams = array_filter($_GET,
    function ($key) use ($allowedParams) {
        return in_array($key, $allowedParams);
    },
    ARRAY_FILTER_USE_KEY
);

if (empty($filteredParams) === false) {
    $query_string = http_build_query($filteredParams);
    $url .= '?' . $query_string;
}
?>

<article class="<?php echo $class; ?> card-category-travel-wrapper">

        <div data-pm-id="<?php echo $mo->id; ?>" data-pm-ot="<?php echo $mo->id_object_type; ?>"
             data-pm-dr="<?php echo !is_null($cheapest_price) ? $cheapest_price->date_arrival->format('Ymd') . '-' . $cheapest_price->date_arrival->format('Ymd') : ''; ?>"
             data-pm-du="<?php echo !is_null($cheapest_price) ? $cheapest_price->duration : ''; ?>"
             class="add-to-wishlist">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-heart" width="30"
                 height="30" viewBox="0 0 24 24" stroke-width="1.5" stroke="#06f" fill="none"
                 stroke-linecap="round"
                 stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                <path class="wishlist-heart"
                      d="M19.5 13.572l-7.5 7.428l-7.5 -7.428m0 0a5 5 0 1 1 7.5 -6.566a5 5 0 1 1 7.5 6.572"/>
            </svg>
        </div>

        <section class="card-body">

            <h1 class="card-title">
                <a href="<?php echo $url; ?>"><?php echo strip_tags($mo->name); ?></a>
            </h1>


            <div class="bottom-aligned">
                <?php

                $c_dates = 0;
                foreach ($mo->booking_packages as $booking_package) {
                    $c_dates += count($booking_package->dates);
                }

                // cheapest price
                if (empty($cheapest_price->price_option) === false) {

                    $month = ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
                    $weekdays = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];

                    ?>


                    <div class="card-text discount-row">

                        <?php
                        if (!empty($cheapest_price->price_option_pseudo) && $cheapest_price->price_option_pseudo > $cheapest_price->price_total) {
                            $percent_discount = round((100 / $cheapest_price->price_option_pseudo) * ($cheapest_price->price_option_pseudo - $cheapest_price->price_total));
                            ?>
                            <div class="discount-wrapper">

                                <p>
                                    <span class="msg">Ihr Vorteil</span>
                                    <span class="discount-label">
                                <span class="price"><?php echo $cheapest_price->price_option_pseudo; ?>&nbsp;€</span>
                                <span class="discount"> -<?php echo $percent_discount; ?>%</span>
                            </span>
                                </p>
                            </div>
                            <?php
                        }
                        ?>
                    </div>
                    <div class="card-text price-row">

                        <span class="small">
                            <?php
                            echo '<span>' . $cheapest_price->duration . ' Tage Reise</span><br>';
                            ?>
                        </span>

                        <a href="<?php echo $url; ?>" class="product-price">
                            <?php
                            if (empty($cheapest_price->price_total) === false) {
                                echo '<small><span>Preis p.P.</span> <strong>ab</strong> </small><strong>' . number_format($cheapest_price->price_total, TS_PRICE_DECIMALS, TS_PRICE_DECIMAL_SEPARATOR, TS_PRICE_THOUSANDS_SEPARATOR) . '&nbsp;€</strong>';
                            } else {
                                ?>zur Reise<?php
                            }
                            ?>
                        </a>
                    </div>
                    <?php
                } // if cheapest price is set
                ?>
            </div>

        </section>

</article>