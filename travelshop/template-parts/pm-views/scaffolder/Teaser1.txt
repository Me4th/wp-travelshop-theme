<?php
/**
 * @var array $data
 */

/**
 * @var Pressmind\ORM\Object\MediaObject $mo
 */

use Pressmind\Search\CheapestPrice;

$mo = $data['media_object'];

/**
 * @var Custom\MediaType\###CLASSNAME### $moc
 */
$moc = $mo->getDataForLanguage(TS_LANGUAGE_CODE);

/**
 * Set the Cheapest Price, based on the current search parameters
 */

$CheapestPriceFilter = new CheapestPrice();

if (empty($_GET['pm-dr']) === false) {
    $dateRange = BuildSearch::extractDaterange($_GET['pm-dr']);
    if ($dateRange !== false) {
        $CheapestPriceFilter->date_from = $dateRange[0];
        $CheapestPriceFilter->date_to = $dateRange[1];
    }
}

if (empty($_GET['pm-du']) === false) {
    $durationRange = BuildSearch::extractDurationRange($_GET['pm-du']);
    if ($durationRange !== false) {
        $CheapestPriceFilter->duration_from = $durationRange[0];
        $CheapestPriceFilter->duration_to = $durationRange[1];
    }
}


/* TODO missing:
if (empty($_GET['pm-pr']) === false) {
    $priceRange = BuildSearch::extractPriceRange($_GET['pm-pr']);
    if ($priceRange !== false) {
        $CheapestPriceFilter->price_from = $priceRange[0];
        $CheapestPriceFilter->price_to = $priceRange[1];
    }
}
*/

$cheapest_price = $mo->getCheapestPrice($CheapestPriceFilter);

$class = empty($data['custom_data']->class) ? 'col-12 col-md-6 col-lg-3' : $data['custom_data']->class;

// TODO, current sdk hotfix, initialize magic methods, to check them with empty() on later usages
foreach(['reiseart_default', 'zielgebiet_default'] as $v){
    is_callable($moc->{$v});
}

/**
 * DON'T USE WordPress Stuff here
 */
?>

<?php
    // Build the detail-page link,
    // we add some search values to deliver to customize the offers on the the detail page
    $url = SITE_URL .$mo->getPrettyUrl(TS_LANGUAGE_CODE);

    // only this search params are transmitted, price range (pm-pr), date range (pm-dr)
    $allowedParams = ['pm-pr', 'pm-dr'];
    $filteredParams = array_filter($_GET,
        function ($key) use ($allowedParams) {
            return in_array($key, $allowedParams);
        },
        ARRAY_FILTER_USE_KEY
    );

    if(empty($filteredParams) === false){
        $query_string = http_build_query($filteredParams);
        $url .= '?'.$query_string;
    }
?>

<div class="<?php echo $class; ?> card-travel-wrapper">
    <div class="card card-travel">

        <div class="container">

        <div class="row">

        <?php
        if (empty($moc->bilder_default[0]) === false) {
            ?>

            <div class="card-image-holder col-4 col-sm-5 col-md-12 p-0">
                <div class="card-badge card-badge--new">
                    <!--<div class="card-badge card-badge--top-offer">-->
                    Neu
                </div>
                <div data-pm-id="<?php echo $mo->id; ?>"
                     data-pm-ot="<?php echo $mo->id_object_type; ?>"
                     data-pm-dr="<?php echo !is_null($cheapest_price) ? $cheapest_price->date_arrival->format('Ymd').'-'.$cheapest_price->date_arrival->format('Ymd') : ''; ?>"
                     data-pm-du="<?php echo !is_null($cheapest_price) ? $cheapest_price->duration : ''; ?>"
                     class="add-to-wishlist">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-heart" width="30" height="30" viewBox="0 0 24 24" stroke-width="1.5" stroke="#06f" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path class="wishlist-heart" d="M19.5 13.572l-7.5 7.428l-7.5 -7.428m0 0a5 5 0 1 1 7.5 -6.566a5 5 0 1 1 7.5 6.572" />
                    </svg>
                </div>
                <a href="<?php echo $url; ?>">
                    <img src="<?php echo $moc->bilder_default[0]->getUri('teaser'); ?>"
                        title="<?php echo $moc->bilder_default[0]->copyright; ?>"
                        alt="<?php echo strip_tags($moc->headline_default); ?>"
                        class="card-img-top"
                        loading="lazy"
                    >
                </a>
            </div>

        <?php } ?>

        <div class="card-body col-8 col-sm-7 col-md-12">

            <h5 class="card-title">
                <a href="<?php echo $url; ?>"><?php echo strip_tags($moc->headline_default); ?></a>
            </h5>
            <p class="attribute-row">
                <?php
                    $breadcrumb = array();

                    if(!empty($moc->reiseart_default)){
                        foreach ($moc->reiseart_default as $mocart_default_item) {
                            $mocart = $mocart_default_item->toStdClass();
                            $breadcrumb[] = $mocart->item->name;
                        }
                    }

                    if(!empty($moc->zielgebiet_default)){
                        foreach ($moc->zielgebiet_default as $k => $zielgebiet_default_item) {
                            $zielgebiet = $zielgebiet_default_item->toStdClass();
                            $breadcrumb[] = $zielgebiet->item->name;
                        }
                    }

                    if(!empty($breadcrumb)){
                        echo '<span class="badge badge-secondary">' . implode('</span> <span class="badge badge-secondary">', $breadcrumb) . '</span>';
                    }

                ?>
            </p>

            <?php if(empty($moc->subline_default) === false){?>
            <p class="card-text subline">
                <?php echo strip_tags($moc->subline_default); ?>
                <span class="fade-out"></span>
            </p>

            <?php } ?>


            <p class="card-text price-row">


                <?php

                $c_dates = 0;
                foreach($mo->booking_packages as $booking_package){
                    $c_dates += count($booking_package->dates);
                }

                // cheapest price
                if (empty($cheapest_price->price_option) === false) { ?>
                    <span class="small">
                        <?php
                        echo '<span>' . $cheapest_price->duration . ' Tage Reise</span><br>';

                        echo '<span><i class="circle green"></i>'.$cheapest_price->date_departure->format('d.m') . ' - ' . $cheapest_price->date_arrival->format('d.m.Y').'</span>';

                        if($c_dates > 2){
                            echo '<br><span>'.($c_dates - 1).' weitere Termine</span>';
                        }


                        ?>
                    </span><br class="d-none d-md-block" />
                    <a href="<?php echo $url; ?>">
                        <strong class="h5 mt-0 mb-0"><?php
                            echo ' ab ' . number_format($cheapest_price->price_option, 0, ',', '.') . '&nbsp;â‚¬';
                            ?>
                        </strong>
                    </a>

                    <?php
                }
                ?>
            </p>

            <a href="<?php echo $url; ?>" class="btn btn-primary stretched-link">zur Reise</a>
        </div>

        </div>

        </div>

    </div>
</div>