<?php
/**
 * @var array $data
 */

/**
 * @var Custom\MediaType\###CLASSNAME### $reise
 */
$reise = $data['data'];

/**
 * @var Pressmind\ORM\Object\Touristic\Booking\Package[] $booking_packages
 */
$booking_packages = $data['booking_packages'];

/**
 * @var Pressmind\ORM\Object\MediaObject $media_object
 */
$media_object = $data['media_object'];

$cheapest_price = $media_object->getCheapestPrice();

$class = empty($data['custom_data']->class) ? 'col-12 col-md-6 col-lg-3' : $data['custom_data']->class;


/**
 * DON'T USE WordPress Stuff here
 */
?>

<?php
    // Build the detail-page link,
    // we add some search values to deliver to customize the offers on the the detail page
    $url = SITE_URL . $media_object->getPrettyUrl();

    // only this search params are transmitted, price range (pm-pr), date range (pm-dr)
    $allowedParams = ['pm-pr', 'pm-dr'];
    $filteredParams = array_filter($_GET,
        function ($key) use ($allowedParams) {
            return in_array($key, $allowedParams);
        },
        ARRAY_FILTER_USE_KEY
    );

    if(empty($filteredParams) === false){
        $query_string = http_build_query($filteredParams);
        $url .= '?'.$query_string;
    }
?>

<div class="<?php echo $class; ?> card-travel-wrapper">
    <div class="card card-travel">

        <div class="container">

        <div class="row">

        <?php
        if (empty($reise->bilder_default[0]) === false) {
            ?>

            <div class="card-image-holder col-4 col-sm-5 col-md-12 p-0">
                <div class="card-badge card-badge--new">
                    <!--<div class="card-badge card-badge--top-offer">-->
                    Neu
                </div>
                <a href="<?php echo $url; ?>">
                    <img src="<?php echo $reise->bilder_default[0]->getUri('teaser'); ?>"
                        title="<?php echo $reise->bilder_default[0]->copyright; ?>"
                        alt="<?php echo strip_tags($reise->headline_default); ?>"
                        class="card-img-top"
                        loading="lazy"
                    >
                </a>
            </div>

        <?php } ?>

        <div class="card-body col-8 col-sm-7 col-md-12">

            <h5 class="card-title">
                <a href="<?php echo $url; ?>"><?php echo strip_tags($reise->headline_default); ?></a>
            </h5>
            <p class="attribute-row">
                <?php
                    $breadcrumb = array();
                    if(!empty($reise->reiseart_default)){
                        foreach ($reise->reiseart_default as $reiseart_default_item) {
                            $reiseart = $reiseart_default_item->toStdClass();
                            $breadcrumb[] = $reiseart->item->name;
                        }
                    }
                    if(!empty($reise->zielgebiet_default)){
                        foreach ($reise->zielgebiet_default as $k => $zielgebiet_default_item) {
                            $zielgebiet = $zielgebiet_default_item->toStdClass();
                            $breadcrumb[] = $zielgebiet->item->name;
                        }
                    }
                    if(!empty($breadcrumb)){
                        echo '<span class="badge badge-secondary">' . implode('</span> <span class="badge badge-secondary">', $breadcrumb) . '</span>';
                    }

                               ?>
            </p>

            <?php if(empty($reise->subline_default) === false){?>
            <p class="card-text subline">
                <?php echo strip_tags($reise->subline_default); ?>
                <span class="fade-out"></span>
            </p>

            <?php } ?>


            <p class="card-text price-row">


                <?php
                // cheapest price
                if (empty($cheapest_price->price_option) === false) { ?>
                    <span class="small">
                        <?php
                        echo '<span>' . $cheapest_price->duration . ' Tage Reise</span><br>';
                        echo $cheapest_price->date_departure->format('d.m') . ' - ' . $cheapest_price->date_arrival->format('d.m.Y');
                        ?>
                    </span><br class="d-none d-md-block" />
                    <a href="<?php echo $url; ?>">
                        <strong class="h5 mt-0 mb-0"><?php
                            echo ' ab ' . number_format($cheapest_price->price_option, 0, ',', '.') . '&nbsp;â‚¬';
                            ?>
                        </strong>
                    </a>

                    <?php
                }
                ?>
            </p>

            <a href="<?php echo $url; ?>" class="btn btn-primary stretched-link">zur Reise</a>
        </div>

        </div>

        </div>

    </div>
</div>